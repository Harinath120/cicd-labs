<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab 6 - Packaging Applications with Docker - CI/CD Lab Guide</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab 6 - Packaging Applications with Docker";
    var mkdocs_page_input_path = "dockerfile.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> CI/CD Lab Guide</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../tests/">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../dockerintro/">Lab 1 - Docker for CI/CD</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../git/">Lab 2 - Revision Control with Git</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../jenkins/">Lab 3 - Setting up CI Pipeline with Jenkins</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../jenkinsfile/">Lab 4 - Dev Workflow & Pipeline as a Code with Jenkinsfile</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../dockerjenkins/">Lab 5 - Using Docker to Simplify Jenkins Pipeline</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Lab 6 - Packaging Applications with Docker</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#packaging-with-docker">Packaging with Docker</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#registering-with-the-dockerhub">Registering with the DockerHub</a></li>
        
            <li><a class="toctree-l3" href="#lab-building-docker-images-a-manual-approach">Lab: Building Docker Images - A manual approach</a></li>
        
            <li><a class="toctree-l3" href="#lab-building-images-with-dockerfile">Lab: Building Images with Dockerfile</a></li>
        
            <li><a class="toctree-l3" href="#adding-docker-build-stage-to-jenkinsfile">Adding docker build stage to Jenkinsfile</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../devdeploycompose/">Lab 7 - Deploy to Dev with Compose</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../tests/">Lab 8 - Adding Automated Testing</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">CI/CD Lab Guide</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Lab 6 - Packaging Applications with Docker</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="packaging-with-docker">Packaging with Docker</h1>
<p>In addition to helping  the process of building and testing software, docker could also provide a standard packaging format i.e. docker images.   Along with this packaging format, comes the distribution mechanism i.e.  docker image registries.   </p>
<p>In this lab you are going to learn,</p>
<ul>
<li>about Dockerâ€™s standard imaging format</li>
<li>How to test build docker images  manually</li>
<li>Learn how to write Dockerfiles</li>
<li>understand the automated, iterative docker image process</li>
<li>add docker packaging stage to the jenkins pipeline</li>
<li>create per stage agent configurations in Jenkinsfile</li>
</ul>
<h2 id="registering-with-the-dockerhub">Registering with the DockerHub</h2>
<p>Since you  are going to start working with the registry, build and push images to it later, its essential to have your own account on the registry. For the purpose of this tutorial, you are going to use the hosted registry i.e. Dockerhub.</p>
<p>Steps to create Dockerhub account</p>
<h4 id="step-1">Step 1:</h4>
<p>Visit the following link and sign up with your email id<br />
<strong>https://hub.docker.com/</strong></p>
<p><img alt="hub" src="../images/hub1.png" /></p>
<h4 id="step-2">Step 2:</h4>
<p>Check your email inbox and check the activation email sent by docker team</p>
<h4 id="step-3">Step 3:</h4>
<p>After clicking on the activation link, you will be redirected to a log in page. Enter your credentials and log in</p>
<p><img alt="hub" src="../images/hub2.png" /></p>
<p>You will be launched to Dockerhub main page. Now the registration process is complete and you have account in Dockerhub!</p>
<p><img alt="hub" src="../images/hub3.png" /></p>
<h2 id="lab-building-docker-images-a-manual-approach">Lab: Building Docker Images - A manual approach</h2>
<p>Before you start building automated images, you are going to create a docker image by hand. you have already used the pre built image from the registry in the last session. In this sub section, you are going to create an image with worker application installed. Since worker  is a java based application, and needs maven to build it,  you will base our work on existing official image for <strong>maven</strong>.</p>
<ul>
<li>Clone Repository for Java worker app</li>
</ul>
<p><code>git clone https://github.com/schoolofdevops/example-voting-app.git</code></p>
<ul>
<li>Launch an intermediate container to install worker app</li>
</ul>
<p>Create a Container with  <strong>schoolofdevops/voteapp-mvn:v1</strong> image</p>
<p><code>docker run -idt --name build maven:3.6.1-jdk-8-slim sh</code></p>
<ul>
<li>
<p>Copy over the Source Code
  <code>cd example-voting-app/worker
  docker container cp .  build:/app</code></p>
</li>
<li>
<p>Connect to container to compile and package the code</p>
</li>
</ul>
<p>```
  docker exec -it build sh</p>
<p>mvn package</p>
<p>```</p>
<ul>
<li>Verify jarfile has been built</li>
</ul>
<p>```
  ls target/</p>
<p>java -jar target/worker-jar-with-dependencies.jar
  ```</p>
<p>[sample output]
  <code>/app # java -jar target/worker-jar-with-dependencies.jar
  Waiting for redis
  Waiting for redis
  Waiting for redis
  Waiting for redis
  Waiting for redis
  Waiting for redis
  ^c</code>
  [use ^c to exit]</p>
<p>The above is the expected output. The <strong>worker</strong> app keeps waiting for <strong>redis</strong> and then later <strong>db</strong> in a loop.</p>
<ul>
<li>Move the artifact, remove source code
  ```</li>
</ul>
<p>mv target/worker-jar-with-dependencies.jar /run/worker.jar</p>
<p>rm -rf /app/*</p>
<p>exit
  ```</p>
<ul>
<li>
<p>Commit  container to an image</p>
<ul>
<li>Exit from the container shell</li>
<li>Note container ID</li>
</ul>
</li>
</ul>
<p>Commit the container into a image  as,</p>
<p>```</p>
<p>docker container commit build  <docker hub user id >/worker:v1</p>
<p>```</p>
<p>Test before pushing  by launching container with the packaged app</p>
<p><code>docker run --rm -it  &lt;docker hub user id &gt;/worker:v1 java -jar /run/worker.jar</code></p>
<ul>
<li>Push Image to registry</li>
</ul>
<p>Before you push the image, you need to be logged in to the registry, with the docker hub id created earlier. Login using the following command,</p>
<p><code>docker login</code></p>
<p>To push the image, first list it,</p>
<p><code>docker image ls</code></p>
<p>[Sample Output]</p>
<p>```
  REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE
  initcron/worker         v2              90cbeb6539df        18 minutes ago      194MB
  initcron/worker         v1              c0199f782489        34 minutes ago      189MB</p>
<p>```</p>
<p>To push the image,</p>
<p><code>docker push &lt;dockrhub user id&gt;/worker:v1</code></p>
<h2 id="lab-building-images-with-dockerfile">Lab: Building Images with Dockerfile</h2>
<p>Now, lets build the same image, this time with Dockerfile. To do this, create a file by name <strong>Dockerfile</strong> in the root of the source code.</p>
<p><code>file: example-voting-app/worker/Dockerfile</code></p>
<pre><code>FROM maven:3.6.1-jdk-8-slim

WORKDIR /app

COPY .  .

RUN mvn package &amp;&amp; \
    mv target/worker-jar-with-dependencies.jar /run/worker.jar &amp;&amp; \
    rm -rf /app/*

CMD java  -jar /run/worker.jar

</code></pre>

<p>Lets now build the image</p>
<pre><code>cd example-voting-app/worker

docker image build -t &lt;dockrhub user id&gt;/worker:v2 .

docker image ls

</code></pre>

<p>Try building again,</p>
<pre><code>docker image build -t &lt;dockrhub user id&gt;/worker:v2 .

</code></pre>

<p>This time, it does not build everything, but uses cache.</p>
<p>Testing the image</p>
<pre><code>docker container run --rm -it  &lt;dockrhub user id&gt;/worker:v2

</code></pre>

<p>Tag the image as latest,</p>
<pre><code>docker image tag  &lt;dockrhub user id&gt;/worker:v2  &lt;dockrhub user id&gt;/worker:latest

docker image ls

</code></pre>

<p>Finally, publish it to the registry,</p>
<pre><code>docker image push &lt;dockrhub user id&gt;/worker:latest

docker image push &lt;dockrhub user id&gt;/worker

</code></pre>

<h2 id="adding-docker-build-stage-to-jenkinsfile">Adding docker build stage to Jenkinsfile</h2>
<ul>
<li>Add  username/password type credential to Jenkins with name <strong>dockerlogin</strong>. Do do so, browse to <code>Jenkins -&gt; Credentials -&gt; Jenkins -&gt; Global Credentials -&gt; Add Credentials -&gt; Username and password</code> . Ensure you add the dockerhub login and password with id as <strong>dockerlogin</strong>.
  <img alt="" src="../images/dockerlogin.png" /></li>
<li>Refactor the Jenkinsfile for worker app by adding the following stage</li>
</ul>
<p><code>file: worker/Jenkinsfile</code></p>
<pre><code>stage('docker-package'){
    agent any
    steps{
      echo 'Packaging worker app with docker'
      script{
        docker.withRegistry('https://index.docker.io/v1/', 'dockerlogin') {
            def workerImage = docker.build(&quot;xxxx/worker:v${env.BUILD_ID}&quot;, &quot;./worker&quot;)
            workerImage.push()
            workerImage.push(&quot;latest&quot;)
        }
      }
    }
}
</code></pre>

<p>You have configured the pipelines to run with docker agents. However, the job to create and publish docker image needs to be run directly from the Jenkins server as thats where you have configured docker client to run. In order to support it, you would have to refactor the worker/Jenkinsfile to support per stage agents.</p>
<pre><code>pipeline{

    agent none

    stages{
        stage('build'){
            agent{
              docker{
               image 'maven:3.6.1-jdk-8-slim'
               args '-v $HOME/.m2:/root/.m2'
              }
            }

            steps{
                echo 'building worker app'
                dir('worker'){
                  sh 'mvn compile'
                }
            }
        }
        stage('test'){
            agent{
              docker{
               image 'maven:3.6.1-jdk-8-slim'
               args '-v $HOME/.m2:/root/.m2'
              }
            }
            steps{
                echo 'running unit tests on worker app'
                dir('worker'){
                  sh 'mvn clean test'
                }
            }
        }
        stage('package'){
            agent{
              docker{
               image 'maven:3.6.1-jdk-8-slim'
               args '-v $HOME/.m2:/root/.m2'
              }
            }
            steps{
                echo 'packaging worker app into a jarfile'
                dir('worker'){
                  sh 'mvn package -DskipTests'
                  archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
                }
            }
        }
        stage('docker-package'){
            agent any
            steps{
              echo 'Packaging worker app with docker'
              script{
                docker.withRegistry('https://index.docker.io/v1/', 'dockerlogin') {
                    def workerImage = docker.build(&quot;initcron/worker:v${env.BUILD_ID}&quot;, &quot;./worker&quot;)
                    workerImage.push()
                    workerImage.push(&quot;latest&quot;)
                }
              }
            }
        }
    }

    post{
        always{
            echo 'the job is complete'
        }

    }

}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../devdeploycompose/" class="btn btn-neutral float-right" title="Lab 7 - Deploy to Dev with Compose">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../dockerjenkins/" class="btn btn-neutral" title="Lab 5 - Using Docker to Simplify Jenkins Pipeline"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../dockerjenkins/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../devdeploycompose/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
